<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>นับคะแนน | ระบบนับคะแนนการเลือกตั้งสภานักเรียน</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- API Client -->
    <meta name="gas-api-url" content="https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec">
    <script src="api.js"></script>

    <!-- CSS -->
    <style>
        /* ====================================
   ระบบนับคะแนนการเลือกตั้งสภานักเรียน
   สีประจำโรงเรียน: เขียว, เหลือง, ดำ
   ==================================== */

        :root {
            /* Primary Colors (School) */
            --color-primary-green: #2A9D8F;
            --color-primary-yellow: #E9C46A;
            --color-primary-black: #264653;

            /* Secondary Colors */
            --color-bg-white: #FFFFFF;
            --color-bg-light: #F8F9FA;
            --color-bg-cream: #FFFBF0;

            /* Accent Colors */
            --color-accent-green: #1D7A70;
            --color-accent-yellow: #D4A84B;

            /* Text Colors */
            --color-text-main: #1D1D1F;
            --color-text-dark: #1D1D1F;
            --color-text-muted: #6E6E73;

            /* Status Colors */
            --color-success: #27AE60;
            --color-warning: #F39C12;
            --color-danger: #E74C3C;

            /* Ranking Special Colors */
            --color-gold: #D4AF37;
            --color-silver: #8E8E93;
            --color-bronze: #CD7F32;

            /* Borders & Shadows */
            --color-border: #e5e7eb;
            --border-radius-sm: 8px;
            --border-radius-md: 16px;
            --border-radius-lg: 24px;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 30px rgba(0, 0, 0, 0.15);

            /* Transitions */
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Prompt', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--color-bg-light);
            color: var(--color-text-main);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ===== HEADER - Ultra Minimal ===== */
        .header {
            background: var(--color-bg-white);
            color: var(--color-text-main);
            padding: 10px 0;
            border-bottom: 1px solid var(--color-border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-placeholder {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
        }

        .logo-placeholder img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .system-title {
            display: flex;
            flex-direction: column;
        }

        .system-title h1 {
            font-size: .92rem;
            font-weight: 600;
            color: var(--color-primary-black);
            letter-spacing: -.2px;
            line-height: 1.3;
        }

        .system-title span {
            font-size: .68rem;
            color: var(--color-text-muted);
            font-weight: 400;
        }



        /* Mobile Menu Button */
        .menu-toggle {
            display: none;
            background: #f8f9fa;
            color: var(--color-primary-black);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            width: 40px;
            height: 40px;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 101;
            transition: all 0.2s ease;
        }

        /* Mobile Menu Overlay */
        .mobile-menu {
            position: fixed;
            top: 0;
            right: -100%;
            width: 80%;
            max-width: 300px;
            height: 100vh;
            background: white;
            z-index: 1000;
            padding: 80px 24px 40px;
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: -10px 0 30px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .mobile-menu.active {
            right: 0;
        }

        .mobile-menu-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            z-index: 999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .mobile-menu-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .mobile-nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: #f8f9fa;
            border: 1px solid var(--color-border);
            border-radius: 12px;
            color: var(--color-text-main);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }

        .mobile-nav-link i {
            width: 20px;
            text-align: center;
            color: var(--color-primary-green);
        }

        .mobile-nav-link.active {
            background: rgba(42, 157, 143, 0.1);
            color: var(--color-primary-green);
            border-color: rgba(42, 157, 143, 0.3);
        }

        .mobile-menu-header {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--color-border);
        }

        .mobile-menu-header h3 {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--color-primary-black);
        }

        .mobile-menu-header p {
            font-size: 0.75rem;
            color: var(--color-text-muted);
        }

        .header-actions {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .nav-link {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: .8rem;
            font-weight: 500;
            color: var(--color-text-muted);
            text-decoration: none;
            cursor: pointer;
            transition: var(--transition-fast);
            background: none;
            border: none;
            font-family: inherit;
            padding: 0;
        }

        .nav-link:hover {
            color: var(--color-primary-black);
        }

        .nav-link i {
            font-size: .75rem;
        }

        .nav-divider {
            width: 1px;
            height: 16px;
            background: var(--color-border);
        }



        /* ===== BUTTONS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border-radius: var(--border-radius-md);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition-normal);
            border: none;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--color-primary-green), var(--color-accent-green));
            color: white;
            box-shadow: 0 4px 12px rgba(42, 157, 143, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(42, 157, 143, 0.4);
        }

        .btn-secondary {
            background: var(--color-bg-white);
            color: var(--color-primary-black);
            border: 2px solid var(--color-primary-black);
        }

        .btn-secondary:hover {
            background: var(--color-primary-black);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--color-primary-yellow), var(--color-accent-yellow));
            color: var(--color-primary-black);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--color-danger), #c0392b);
            color: white;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* ... Part 1 Complete ... */

        /* ===== MAIN CONTENT ===== */
        .main-content {
            flex: 1;
            padding: 30px 20px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            padding-bottom: 100px;
            /* Space for footer */
        }

        /* Status Bar */
        .status-bar {
            background: white;
            padding: 15px 20px;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-sm);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-left: 5px solid var(--color-primary-green);
        }

        @media (max-width: 600px) {
            .status-bar {
                flex-direction: column;
                gap: 12px;
                text-align: center;
                padding: 12px;
            }

            .status-bar>div {
                width: 100%;
                display: flex;
                justify-content: center;
            }
        }

        .status-badge {
            background: var(--color-bg-light);
            padding: 6px 16px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .status-badge.active {
            background: #E6F4F1;
            color: var(--color-primary-green);
        }

        .status-badge.active::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--color-primary-green);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        .status-badge.locked {
            background: #F8F9FA;
            color: var(--color-text-muted);
            border: 1px solid var(--color-border);
        }

        /* Locked Banner */
        .locked-banner {
            background: #FFF3CD;
            color: #856404;
            padding: 20px;
            border-radius: var(--border-radius-md);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 20px;
            border: 1px solid #FFEEBA;
        }

        .locked-banner i {
            font-size: 2rem;
        }

        /* ===== VOTE CARDS ===== */
        .vote-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 600px) {
            .vote-cards-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .vote-card {
                padding: 24px 16px;
            }

            .party-name {
                font-size: 1.15rem;
                min-height: auto;
                margin-bottom: 15px;
            }

            .vote-count {
                font-size: 3.8rem;
                margin-bottom: 20px;
            }

            .vote-btn {
                width: 54px;
                height: 54px;
                font-size: 1.6rem;
                border-radius: 12px;
            }
        }

        .vote-card {
            background: white;
            border-radius: var(--border-radius-lg);
            padding: 30px;
            box-shadow: var(--shadow-sm);
            text-align: center;
            transition: var(--transition-normal);
            position: relative;
            overflow: hidden;
            border-top: 5px solid transparent;
        }

        .vote-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }

        /* Party Colors */
        .vote-card.party-1 {
            border-color: #E63946;
        }

        .vote-card.party-2 {
            border-color: #457B9D;
        }

        .vote-card.party-3 {
            border-color: #6A4C93;
        }

        .party-number {
            display: inline-block;
            background: var(--color-primary-black);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .party-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--color-primary-black);
            margin-bottom: 20px;
            min-height: 3.2em;
            /* Ensure equal height */
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.3;
        }

        .vote-count {
            font-size: 4.5rem;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 25px;
            color: var(--color-primary-black);
        }

        .vote-card.party-1 .vote-count {
            color: #E63946;
        }

        .vote-card.party-2 .vote-count {
            color: #457B9D;
        }

        .vote-card.party-3 .vote-count {
            color: #6A4C93;
        }

        .vote-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .vote-btn {
            width: 60px;
            height: 60px;
            border-radius: 16px;
            border: none;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .vote-btn.minus {
            background: #F1F3F5;
            color: var(--color-text-muted);
        }

        .vote-btn.minus:hover {
            background: #E9ECEF;
            color: var(--color-danger);
        }

        .vote-btn.plus {
            background: var(--color-primary-black);
            color: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .vote-btn.plus:hover {
            transform: scale(1.1);
            background: black;
        }

        /* Locked State */
        .vote-card.locked {
            opacity: 0.7;
            pointer-events: none;
            filter: grayscale(0.8);
        }

        /* ===== SPECIAL BALLOTS ===== */
        .special-ballots-section {
            background: #fff;
            padding: 30px;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-sm);
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--color-text-muted);
        }

        .special-ballots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .special-card {
            background: var(--color-bg-light);
            border-radius: var(--border-radius-md);
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid transparent;
        }

        .special-card.no-vote {
            border-color: var(--color-warning);
        }

        .special-card.invalid {
            border-color: var(--color-danger);
        }

        .special-card-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .special-card-icon {
            width: 45px;
            height: 45px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .special-card.no-vote .special-card-icon {
            background: #FFF9E6;
            color: var(--color-warning);
        }

        .special-card.invalid .special-card-icon {
            background: #FDECEA;
            color: var(--color-danger);
        }

        .special-card-label {
            font-weight: 600;
            color: var(--color-text-main);
        }

        .special-card-count {
            font-size: 2rem;
            font-weight: 800;
            color: var(--color-primary-black);
            margin: 0 20px;
        }

        .special-card-controls {
            display: flex;
            gap: 8px;
        }

        .special-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .special-btn.minus {
            background: #e9ecef;
            color: #495057;
        }

        .special-btn.minus:hover {
            background: #dee2e6;
        }

        .special-btn.plus {
            background: var(--color-primary-black);
            color: white;
        }

        .special-btn.plus:hover {
            background: black;
        }

        /* ===== STATS SECTION ===== */
        .stats-section {
            background: var(--color-primary-black);
            color: white;
            padding: 30px;
            border-radius: var(--border-radius-lg);
            text-align: center;
        }

        .stats-title {
            font-size: 1.1rem;
            margin-bottom: 25px;
            opacity: 0.8;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        @media (max-width: 600px) {
            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 12px;
            }

            .stat-value {
                font-size: 1.6rem;
            }

            .stat-label {
                font-size: 0.72rem;
            }

            .stat-item {
                padding: 12px;
            }
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 900;
            line-height: 1;
            margin-bottom: 5px;
        }

        .stat-value.editable {
            border-bottom: 2px dashed rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .stat-value.editable:hover {
            opacity: 0.7;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.7;
        }

        /* ===== FOOTER ===== */
        .footer {
            text-align: center;
            padding: 30px;
            color: var(--color-text-muted);
            font-size: 0.9rem;
            background: #fff;
            border-top: 1px solid var(--color-border);
            margin-top: auto;
        }

        /* Animation */
        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.5);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 0;
            }
        }

        /* Responsive */
        @media (max-width: 900px) {
            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 30px;
            }
        }

        @media (max-width: 600px) {
            .vote-cards-grid {
                grid-template-columns: 1fr;
            }

            .special-ballots-grid {
                grid-template-columns: 1fr;
            }

            .special-card {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .special-card-info {
                flex-direction: column;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 1024px) {
            .header {
                padding: 10px 0;
            }

            .logo-placeholder {
                width: 30px;
                height: 30px;
            }

            .logo-group {
                gap: 8px;
                flex-wrap: nowrap;
            }

            .system-title h1 {
                font-size: 0.82rem;
                letter-spacing: -0.01em;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 160px;
            }

            .system-title span {
                display: none;
            }

            .header-actions {
                display: none !important;
                /* Force hide on mobile */
            }

            .menu-toggle {
                display: flex;
            }
        }
    </style>

</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo-group">
                <div class="logo-placeholder" title="โลโก้โรงเรียน">
                    <img src="https://drive.google.com/thumbnail?id=1l-r_ZGA-N4rKipi5zz4DKOoMJL-W82zW&sz=w300"
                        alt="ตราโรงเรียน">
                </div>
                <div class="logo-placeholder" title="โลโก้สภานักเรียน">
                    <img src="https://drive.google.com/thumbnail?id=1MTw6a6RfcCU-QTIQQ_EyhHLB_8CE9vHy&sz=w300"
                        alt="ตราสภานักเรียน">
                </div>
                <div class="system-title">
                    <h1>ระบบนับคะแนนการเลือกตั้งสภานักเรียน</h1><span>ประจำปีการศึกษา 2569 |
                        โรงเรียนศรีวิชัยวิทยา</span>
                </div>
            </div>
            <div class="header-actions">
                <div id="userRoleBadge"
                    style="margin-right: 15px; font-size: 0.85rem; padding: 4px 12px; border-radius: 20px; background: rgba(var(--color-primary-rgb), 0.1); color: var(--color-primary); font-weight: 600; display: flex; align-items: center; gap: 8px;">
                    <i class="fa-solid fa-user-shield"></i>
                    <span id="roleText">กำลังโหลด...</span>
                </div>
                <a href="#" onclick="navigateTo('counting'); return false;" class="nav-link active"><i
                        class="fa-solid fa-chart-simple"></i> นับคะแนน</a>
                <div class="nav-divider"></div>
                <a href="#" onclick="navigateTo('ballot'); return false;" class="nav-link"><i
                        class="fa-solid fa-check-to-slot"></i> กากบาทลงคะแนน</a>
                <div class="nav-divider"></div>
                <a href="#" onclick="navigateTo('ranking'); return false;" class="nav-link"><i
                        class="fa-solid fa-tv"></i> ผลคะแนนสด</a>
                <div class="nav-divider"></div>
                <button class="nav-link" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i>
                    ออกจากระบบ</button>
            </div>

            <!-- Mobile Hamburger Button -->
            <button class="menu-toggle" onclick="toggleMobileMenu()" id="menuToggleBtn">
                <i class="fa-solid fa-bars"></i>
            </button>
        </div>
    </header>

    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu-overlay" id="menuOverlay" onclick="toggleMobileMenu()"></div>
    <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-header">
            <h3>เมนูระบบ</h3>
            <p>ระบบนับคะแนนสภานักเรียน</p>
            <div id="mobileUserBadge"
                style="margin-top: 10px; font-size: 0.85rem; font-weight: 600; color: var(--color-primary-green);">
                <i class="fa-solid fa-user-circle"></i> <span id="mobileUserName">ผู้ใช้งาน</span>
            </div>
        </div>

        <a href="#" onclick="navigateTo('counting'); toggleMobileMenu(); return false;" class="mobile-nav-link active">
            <i class="fa-solid fa-chart-simple"></i>
            นับคะแนน
        </a>
        <a href="#" onclick="navigateTo('ballot'); toggleMobileMenu(); return false;" class="mobile-nav-link">
            <i class="fa-solid fa-check-to-slot"></i>
            กากบาทลงคะแนน
        </a>
        <a href="#" onclick="navigateTo('ranking'); toggleMobileMenu(); return false;" class="mobile-nav-link">
            <i class="fa-solid fa-tv"></i>
            ผลคะแนนสด
        </a>

        <div style="margin-top: auto;">
            <button class="mobile-nav-link" onclick="logout()"
                style="width: 100%; border: none; background: #fff5f5; color: #e74c3c; text-align: left;">
                <i class="fa-solid fa-right-from-bracket" style="color: #e74c3c;"></i>
                ออกจากระบบ
            </button>
        </div>
    </div>
    <!-- Main Content -->
    <main class="main-content">
        <!-- Status Bar -->
        <div class="status-bar">
            <div><span class="status-badge active" id="statusBadge">กำลังนับคะแนน </span></div>
            <div style="display: flex; gap: 12px; align-items: center;"><span
                    style="color: var(--color-text-muted); font-size: 0.9rem;"><i
                        class="fa-solid fa-user"></i>เข้าสู่ระบบในฐานะ:
                    <strong id="roleIndicator">กำลังโหลด...</strong></span></div>
        </div>
        <!-- Locked Banner (Hidden by default) -->
        <div class="locked-banner" id="lockedBanner" style="display: none;"><i class="fa-solid fa-lock"></i>
            <div>
                <h3>ผลการนับคะแนนถูกล็อคแล้ว</h3>
                <p>ผลคะแนนได้รับการยืนยันจากครูที่ปรึกษาเรียบร้อยแล้ว ไม่สามารถแก้ไขได้</p>
            </div>
        </div>
        <!-- Vote Cards (Dynamic) -->
        <div class="vote-cards-grid" id="voteCardsGrid">
            <!-- Rendered dynamically -->
        </div>
        <!-- Special Ballots Section -->
        <div class="special-ballots-section">
            <h3 class="section-title"><i class="fa-solid fa-file-circle-exclamation"></i>บัตรพิเศษ</h3>
            <div class="special-ballots-grid">
                <!-- No Vote -->
                <div class="special-card no-vote" id="noVoteCard">
                    <div class="special-card-info">
                        <div class="special-card-icon"><i class="fa-solid fa-ban"></i></div>
                        <div class="special-card-label">ไม่ประสงค์ลงคะแนน</div>
                    </div>
                    <div class="special-card-count" id="noVote">0</div>
                    <div class="special-card-controls"><button class="special-btn minus"
                            onclick="updateSpecial('noVote', -1)">−</button><button class="special-btn plus"
                            onclick="updateSpecial('noVote', 1)">+</button></div>
                </div>
                <!-- Invalid Ballot -->
                <div class="special-card invalid" id="invalidCard">
                    <div class="special-card-info">
                        <div class="special-card-icon"><i class="fa-solid fa-circle-xmark"></i></div>
                        <div class="special-card-label">บัตรเสีย</div>
                    </div>
                    <div class="special-card-count" id="invalidBallot">0</div>
                    <div class="special-card-controls"><button class="special-btn minus"
                            onclick="updateSpecial('invalidBallot', -1)">−</button><button class="special-btn plus"
                            onclick="updateSpecial('invalidBallot', 1)">+</button></div>
                </div>
            </div>
        </div>
        <!-- Stats Section -->
        <div class="stats-section">
            <h3 class="stats-title"><i class="fa-solid fa-chart-pie"></i>สรุปผลการนับคะแนน
            </h3>
            <div class="stats-grid">
                <div class="stat-item"><span class="stat-value editable" id="totalEligible"
                        onclick="editStat('totalEligible')" title="คลิกเพื่อแก้ไข">0</span>
                    <div class="stat-label">ผู้มีสิทธิเลือกตั้งทั้งหมด</div>
                </div>
                <div class="stat-item"><span class="stat-value" id="totalVoted"
                        style="color: var(--color-primary-green);">0</span>
                    <div class="stat-label">มาใช้สิทธิ (<span id="turnoutPercent">0</span>%)
                    </div>
                </div>
                <div class="stat-item"><span class="stat-value" id="absentVoters"
                        style="color: var(--color-text-muted);">0</span>
                    <div class="stat-label">ผู้ไม่มาใช้สิทธิ</div>
                </div>
                <div class="stat-item"><span class="stat-value" id="validVotes"
                        style="color: var(--color-accent-green);">0</span>
                    <div class="stat-label">คะแนนที่ถูกต้อง</div>
                </div>
            </div>
        </div>
    </main>
    <!-- Footer -->
    <footer class="footer">
        <div class="footer-disclaimer"><i
                class="fa-solid fa-check-to-slot"></i>ระบบนี้ใช้เพื่อการลงคะแนนเลือกตั้งสภานักเรียน
            โรงเรียนศรีวิชัยวิทยา</div>
        <div class="footer-dev">พัฒนาโดย นายธีรเดช เดชสูงเนิน</div>
    </footer>
    <script>
        let voteData = {};
        let partyConfig = {};

        // Load data via API
        function loadData() {
            if (isApiConfigured()) {
                apiGet('getVoteData').then(function (data) {
                    if (data) {
                        voteData = data;
                        if (data.config) partyConfig = data.config;
                        renderVoteCards();
                        updateDisplay();
                        checkLockStatus();
                    }
                }).catch(function (err) {
                    console.error('Load error:', err);
                });
            }
        }

        function renderVoteCards() {
            var grid = document.getElementById('voteCardsGrid');
            var ids = Object.keys(partyConfig);
            var html = '';
            ids.forEach(function (id) {
                var p = partyConfig[id];
                html += '<div class="vote-card" id="card-' + id + '" style="border-top-color:' + (p.color || '#ccc') + '">' +
                    '<span class="party-number">เบอร์ ' + id + '</span>' +
                    '<div class="party-name">' + p.name + '</div>' +
                    '<div class="vote-count" id="count-' + id + '" style="color:' + (p.color || '#264653') + '">0</div>' +
                    '<div class="vote-controls">' +
                    '<button class="vote-btn minus" onclick="updateVote(\'' + id + '\', -1)">−</button>' +
                    '<button class="vote-btn plus" onclick="updateVote(\'' + id + '\', 1)">+</button>' +
                    '</div></div>';
            });
            grid.innerHTML = html;
        }

        // Update vote count via API
        function updateVote(partyNum, delta) {
            if (voteData.isLocked) {
                alert('ผลคะแนนถูกล็อคแล้ว ไม่สามารถแก้ไขได้');
                return;
            }

            const key = 'party' + partyNum;
            voteData[key] = Math.max(0, voteData[key] + delta);
            updateDisplay();

            if (isApiConfigured()) {
                apiPost('updateVote', { partyNum: partyNum, delta: delta })
                    .then(function (result) {
                        if (!result.success) {
                            alert(result.message);
                            loadData();
                        }
                    })
                    .catch(function (err) {
                        alert('เกิดข้อผิดพลาด: ' + err.message);
                        loadData();
                    });
            }
        }

        // Update special ballot via API
        function updateSpecial(type, delta) {
            if (voteData.isLocked) {
                alert('ผลคะแนนถูกล็อคแล้ว ไม่สามารถแก้ไขได้');
                return;
            }

            voteData[type] = Math.max(0, voteData[type] + delta);
            updateDisplay();

            if (isApiConfigured()) {
                apiPost('updateSpecial', { type: type, delta: delta })
                    .then(function (result) {
                        if (!result.success) {
                            alert(result.message);
                            loadData();
                        }
                    })
                    .catch(function (err) {
                        alert('เกิดข้อผิดพลาด: ' + err.message);
                        loadData();
                    });
            }
        }

        // Update display
        function updateDisplay() {
            var ids = Object.keys(partyConfig);
            var validVotes = 0;
            ids.forEach(function (id) {
                var el = document.getElementById('count-' + id);
                var v = voteData['party' + id] || 0;
                if (el) el.textContent = v;
                validVotes += v;
            });

            document.getElementById('totalEligible').textContent = voteData.totalEligible || 0;
            document.getElementById('noVote').textContent = voteData.noVote || 0;
            document.getElementById('invalidBallot').textContent = voteData.invalidBallot || 0;

            var totalVoted = validVotes + (voteData.noVote || 0) + (voteData.invalidBallot || 0);
            var absentVoters = Math.max(0, (voteData.totalEligible || 0) - totalVoted);
            var turnout = (voteData.totalEligible || 0) > 0 ? ((totalVoted / voteData.totalEligible) * 100).toFixed(2) : 0;

            document.getElementById('totalVoted').textContent = totalVoted;
            document.getElementById('validVotes').textContent = validVotes;
            document.getElementById('absentVoters').textContent = absentVoters;
            document.getElementById('turnoutPercent').textContent = turnout;
        }

        // Edit statistics via API
        function editStat(statId) {
            if (voteData.isLocked) {
                alert('ผลคะแนนถูกล็อคแล้ว ไม่สามารถแก้ไขได้');
                return;
            }

            const currentValue = voteData[statId];
            const newValue = prompt('กรุณาใส่จำนวน (ปัจจุบัน: ' + currentValue + ')', currentValue);

            if (newValue !== null && !isNaN(newValue)) {
                const val = Math.max(0, parseInt(newValue) || 0);
                voteData[statId] = val;
                updateDisplay();

                if (isApiConfigured()) {
                    apiPost('editStat', { statId: statId, value: val })
                        .then(function (result) {
                            if (!result.success) {
                                alert(result.message);
                                loadData();
                            }
                        })
                        .catch(function (err) {
                            alert('เกิดข้อผิดพลาด: ' + err.message);
                            loadData();
                        });
                }
            }
        }

        // Check lock status
        function checkLockStatus() {
            if (voteData.isLocked) {
                document.getElementById('lockedBanner').style.display = 'flex';
                document.getElementById('statusBadge').className = 'status-badge locked';
                document.getElementById('statusBadge').innerHTML = '<i class="fa-solid fa-lock"></i> ล็อคแล้ว';

                document.querySelectorAll('.vote-btn').forEach(btn => btn.disabled = true);
                document.querySelectorAll('.special-btn').forEach(btn => btn.disabled = true);
                document.querySelectorAll('.vote-card').forEach(card => card.classList.add('locked'));
                document.querySelectorAll('.special-card').forEach(card => card.style.opacity = '0.6');

                document.querySelectorAll('.stat-value.editable').forEach(el => {
                    el.classList.remove('editable');
                    el.onclick = null;
                });
            }
        }

        // Logout
        function logout() {
            localStorage.removeItem('userRole');
            localStorage.removeItem('userName');
            navigateTo('index');
        }

        // Initialize
        window.onload = function () {
            const role = localStorage.getItem('userRole');
            const userName = localStorage.getItem('userName') || 'ผู้ใช้งาน';

            if (role) {
                const badgeText = document.getElementById('roleText');
                const nameText = document.getElementById('userNameText');
                const roleInd = document.getElementById('roleIndicator');
                const badge = document.getElementById('userRoleBadge');

                if (role === 'advisor') {
                    badgeText.textContent = 'ครูที่ปรึกษา';
                    if (nameText) nameText.style.display = 'none';
                    roleInd.textContent = 'ครูที่ปรึกษา (Admin)';
                    badge.style.color = '#2563eb';
                    badge.style.background = 'rgba(37, 99, 235, 0.1)';
                } else if (role === 'committee') {
                    badgeText.textContent = 'กรรมการสภา';
                    if (nameText) {
                        nameText.textContent = userName;
                        nameText.style.display = 'inline';
                    }
                    roleInd.textContent = userName + ' (กรรมการสภา)';
                    badge.style.color = '#10b981';
                    badge.style.background = 'rgba(16, 185, 129, 0.1)';
                }
            } else {
                navigateTo('index');
            }

            loadData();
            setInterval(loadData, 3000);
        }

        // Toggle Mobile Menu
        function toggleMobileMenu() {
            var menu = document.getElementById('mobileMenu');
            var overlay = document.getElementById('menuOverlay');
            var btnIcon = document.querySelector('#menuToggleBtn i');

            if (!menu || !overlay || !btnIcon) return;

            menu.classList.toggle('active');
            overlay.classList.toggle('active');

            if (menu.classList.contains('active')) {
                btnIcon.className = 'fa-solid fa-xmark';
                document.body.style.overflow = 'hidden';
            } else {
                btnIcon.className = 'fa-solid fa-bars';
                document.body.style.overflow = '';
            }
        }
    </script>
</body>

</html>